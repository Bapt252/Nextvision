#!/bin/bash

# üöÄ Nextvision v2.0 - Script de D√©ploiement Automatis√©
# 
# D√©ploiement complet de l'architecture bidirectionnelle :
# - Validation environnement
# - Installation d√©pendances  
# - Migration donn√©es (69 CVs + 35 FDPs)
# - Tests automatis√©s
# - D√©marrage serveur
#
# Usage: ./deploy_nextvision_v2.sh [--production|--development]

set -e  # Arr√™t si erreur

# === CONFIGURATION ===

VERSION="2.0.0"
PYTHON_MIN_VERSION="3.8"
API_PORT=8000
ENVIRONMENT=${1:-development}

# Couleurs pour logs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# === FONCTIONS UTILITAIRES ===

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "\n${PURPLE}=== $1 ===${NC}"
}

# === V√âRIFICATIONS PR√âREQUIS ===

check_python_version() {
    log_step "V√©rification Python"
    
    if ! command -v python3 &> /dev/null; then
        log_error "Python 3 non trouv√©. Installation requise."
        exit 1
    fi
    
    PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
    log_info "Python version: $PYTHON_VERSION"
    
    # V√©rification version minimale
    if ! python3 -c "import sys; sys.exit(0 if sys.version_info >= (3, 8) else 1)"; then
        log_error "Python >= $PYTHON_MIN_VERSION requis. Version actuelle: $PYTHON_VERSION"
        exit 1
    fi
    
    log_success "Python version OK"
}

check_git_branch() {
    log_step "V√©rification Git"
    
    if ! command -v git &> /dev/null; then
        log_warning "Git non trouv√©. Certaines fonctionnalit√©s seront limit√©es."
        return 0
    fi
    
    CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
    log_info "Branche Git: $CURRENT_BRANCH"
    
    if [[ "$CURRENT_BRANCH" != "feature/bidirectional-matching-v2" && "$CURRENT_BRANCH" != "main" ]]; then
        log_warning "Branche inattendue. Recommand√©: feature/bidirectional-matching-v2"
    fi
    
    log_success "Git configuration OK"
}

check_port_availability() {
    log_step "V√©rification Port $API_PORT"
    
    if netstat -tuln 2>/dev/null | grep -q ":$API_PORT "; then
        log_warning "Port $API_PORT d√©j√† utilis√©. Arr√™t du service existant..."
        
        # Tentative d'arr√™t gracieux
        pkill -f "uvicorn.*:$API_PORT" 2>/dev/null || true
        sleep 2
        
        if netstat -tuln 2>/dev/null | grep -q ":$API_PORT "; then
            log_error "Impossible de lib√©rer le port $API_PORT"
            exit 1
        fi
    fi
    
    log_success "Port $API_PORT disponible"
}

# === INSTALLATION ===

setup_python_environment() {
    log_step "Configuration Environnement Python"
    
    # Cr√©ation virtual environment si n√©cessaire
    if [[ "$ENVIRONMENT" == "production" ]]; then
        if [[ ! -d "venv" ]]; then
            log_info "Cr√©ation virtual environment..."
            python3 -m venv venv
        fi
        
        log_info "Activation virtual environment..."
        source venv/bin/activate
    fi
    
    # Mise √† jour pip
    log_info "Mise √† jour pip..."
    python3 -m pip install --upgrade pip
    
    log_success "Environnement Python configur√©"
}

install_dependencies() {
    log_step "Installation D√©pendances"
    
    # Installation requirements principal
    if [[ -f "requirements.txt" ]]; then
        log_info "Installation requirements.txt..."
        pip install -r requirements.txt
    fi
    
    # Installation requirements production si n√©cessaire
    if [[ "$ENVIRONMENT" == "production" && -f "requirements-production.txt" ]]; then
        log_info "Installation requirements-production.txt..."
        pip install -r requirements-production.txt
    fi
    
    # D√©pendances tests
    log_info "Installation d√©pendances tests..."
    pip install pytest pytest-asyncio psutil
    
    log_success "D√©pendances install√©es"
}

setup_configuration() {
    log_step "Configuration Application"
    
    # Configuration .env
    if [[ ! -f ".env" ]]; then
        if [[ -f ".env.example" ]]; then
            log_info "Cr√©ation .env depuis .env.example..."
            cp .env.example .env
            log_warning "Pensez √† configurer votre cl√© Google Maps dans .env"
        else
            log_info "Cr√©ation .env minimal..."
            cat > .env << EOF
# Nextvision v2.0 Configuration
ENVIRONMENT=$ENVIRONMENT
API_PORT=$API_PORT
LOG_LEVEL=INFO

# Google Maps (optionnel)
GOOGLE_MAPS_API_KEY=YOUR_API_KEY

# Database (optionnel)  
DATABASE_URL=sqlite:///nextvision.db
EOF
        fi
    fi
    
    # Cr√©ation r√©pertoires n√©cessaires
    mkdir -p data/{CV_TEST,FDP_TEST,bidirectional_migrated,logs}
    mkdir -p logs
    
    log_success "Configuration OK"
}

# === MIGRATION DONN√âES ===

migrate_data() {
    log_step "Migration Donn√©es Bidirectionnelles"
    
    if [[ -f "scripts/migrate_data_to_bidirectional.py" ]]; then
        log_info "Lancement migration 69 CVs + 35 FDPs..."
        
        # Timeout de 5 minutes pour la migration
        timeout 300 python3 scripts/migrate_data_to_bidirectional.py || {
            log_warning "Migration timeout ou √©chou√©e. G√©n√©ration donn√©es test..."
            # La migration g√©n√®re automatiquement des donn√©es test si les vrais fichiers ne sont pas trouv√©s
        }
        
        # V√©rification r√©sultats
        if [[ -d "data/bidirectional_migrated" ]]; then
            CANDIDATS_COUNT=$(find data/bidirectional_migrated/candidats -name "*.json" 2>/dev/null | wc -l)
            ENTREPRISES_COUNT=$(find data/bidirectional_migrated/entreprises -name "*.json" 2>/dev/null | wc -l)
            
            log_info "Donn√©es migr√©es: $CANDIDATS_COUNT candidats, $ENTREPRISES_COUNT entreprises"
            log_success "Migration donn√©es termin√©e"
        else
            log_warning "Pas de donn√©es migr√©es - tests avec donn√©es synth√©tiques"
        fi
    else
        log_warning "Script de migration non trouv√© - donn√©es test seulement"
    fi
}

# === TESTS ===

run_tests() {
    log_step "Ex√©cution Tests Automatis√©s"
    
    if [[ -f "tests/test_bidirectional_architecture.py" ]]; then
        log_info "Lancement tests bidirectionnels..."
        
        # Tests avec timeout
        timeout 120 python3 -m pytest tests/test_bidirectional_architecture.py \
            -v \
            --tb=short \
            --durations=5 \
            || {
                log_warning "Certains tests ont √©chou√© - d√©ploiement continue"
                return 0
            }
        
        log_success "Tests valid√©s"
    else
        log_warning "Tests automatis√©s non trouv√©s"
    fi
}

# === D√âMARRAGE ===

start_server() {
    log_step "D√©marrage Serveur Nextvision v2.0"
    
    # Choix du fichier main selon environnement
    MAIN_FILE="main_v2.py"
    if [[ "$ENVIRONMENT" == "production" && -f "main_production.py" ]]; then
        MAIN_FILE="main_production.py"
    fi
    
    if [[ ! -f "$MAIN_FILE" ]]; then
        log_error "Fichier principal $MAIN_FILE non trouv√©"
        exit 1
    fi
    
    log_info "D√©marrage $MAIN_FILE sur port $API_PORT..."
    
    if [[ "$ENVIRONMENT" == "production" ]]; then
        # Mode production : background avec logs
        nohup python3 "$MAIN_FILE" > logs/nextvision.log 2>&1 &
        SERVER_PID=$!
        echo $SERVER_PID > logs/nextvision.pid
        
        sleep 3
        
        # V√©rification d√©marrage
        if kill -0 $SERVER_PID 2>/dev/null; then
            log_success "Serveur d√©marr√© en arri√®re-plan (PID: $SERVER_PID)"
            log_info "Logs: tail -f logs/nextvision.log"
        else
            log_error "√âchec d√©marrage serveur"
            exit 1
        fi
    else
        # Mode d√©veloppement : foreground
        log_info "Mode d√©veloppement - serveur en foreground"
        log_info "Arr√™t avec Ctrl+C"
        python3 "$MAIN_FILE"
    fi
}

# === VALIDATION POST-D√âPLOIEMENT ===

validate_deployment() {
    log_step "Validation D√©ploiement"
    
    # Attendre que le serveur soit pr√™t
    sleep 5
    
    # Test health check
    log_info "Test health check..."
    
    if command -v curl &> /dev/null; then
        if curl -f "http://localhost:$API_PORT/api/v1/health" >/dev/null 2>&1; then
            log_success "Health check v1.0 OK"
        else
            log_warning "Health check v1.0 √©chou√©"
        fi
        
        if curl -f "http://localhost:$API_PORT/api/v2/matching/health" >/dev/null 2>&1; then
            log_success "Health check bidirectionnel v2.0 OK"
        else
            log_warning "Health check bidirectionnel √©chou√©"
        fi
    else
        log_warning "curl non disponible - tests manuels requis"
    fi
    
    # Affichage URLs importantes
    log_info "URLs importantes:"
    echo "  üìö Documentation: http://localhost:$API_PORT/docs"
    echo "  ‚ù§Ô∏è Health v1.0: http://localhost:$API_PORT/api/v1/health"
    echo "  üéØ Health v2.0: http://localhost:$API_PORT/api/v2/matching/health"
    echo "  üöÄ Pipeline: http://localhost:$API_PORT/api/v2/conversion/commitment/direct-match"
}

# === NETTOYAGE ===

cleanup_on_exit() {
    if [[ "$ENVIRONMENT" == "development" ]]; then
        log_info "Nettoyage ressources d√©veloppement..."
        # Nettoyage si n√©cessaire
    fi
}

trap cleanup_on_exit EXIT

# === MENU PRINCIPAL ===

show_banner() {
    echo -e "${PURPLE}"
    echo "üéØ =============================================="
    echo "   NEXTVISION v$VERSION - D√âPLOIEMENT"
    echo "   Matching Bidirectionnel IA Adaptatif"
    echo "=============================================="
    echo -e "${NC}"
    echo "Environment: $ENVIRONMENT"
    echo "Port API: $API_PORT"
    echo ""
}

show_help() {
    echo "Usage: $0 [--production|--development]"
    echo ""
    echo "Options:"
    echo "  --production   D√©ploiement production (venv, background)"
    echo "  --development  D√©ploiement d√©veloppement (foreground)"
    echo "  --help         Affiche cette aide"
    echo ""
    echo "√âtapes du d√©ploiement:"
    echo "  1. V√©rification pr√©requis"
    echo "  2. Installation d√©pendances"
    echo "  3. Configuration application"
    echo "  4. Migration donn√©es bidirectionnelles"
    echo "  5. Tests automatis√©s"
    echo "  6. D√©marrage serveur"
    echo "  7. Validation d√©ploiement"
}

# === EX√âCUTION PRINCIPALE ===

main() {
    show_banner
    
    case ${1:-} in
        --help|-h)
            show_help
            exit 0
            ;;
        --production)
            ENVIRONMENT="production"
            ;;
        --development|"")
            ENVIRONMENT="development"
            ;;
        *)
            log_error "Option inconnue: $1"
            show_help
            exit 1
            ;;
    esac
    
    log_info "D√©marrage d√©ploiement Nextvision v$VERSION ($ENVIRONMENT)"
    
    # √âtapes du d√©ploiement
    check_python_version
    check_git_branch
    check_port_availability
    
    setup_python_environment
    install_dependencies
    setup_configuration
    
    migrate_data
    run_tests
    
    start_server
    
    if [[ "$ENVIRONMENT" == "production" ]]; then
        validate_deployment
        
        log_success "üéâ D√©ploiement production termin√© !"
        log_info "Serveur en arri√®re-plan - PID: $(cat logs/nextvision.pid 2>/dev/null || echo 'N/A')"
        log_info "Arr√™t: kill \$(cat logs/nextvision.pid)"
    else
        log_success "üéâ D√©ploiement d√©veloppement termin√© !"
        log_info "Serveur en foreground - Arr√™t avec Ctrl+C"
    fi
}

# Lancement si script ex√©cut√© directement
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
