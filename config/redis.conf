# üî¥ Redis Production Configuration - Nextvision Enterprise
# Optimis√© pour cache haute performance et persistence

# ==========================================
# üåê NETWORK CONFIGURATION
# ==========================================

# Bind to all interfaces in Docker
bind 0.0.0.0
port 6379
protected-mode yes

# TCP configuration
tcp-backlog 511
tcp-keepalive 300

# ==========================================
# üîí SECURITY CONFIGURATION
# ==========================================

# Authentication (set via environment variable)
# requirepass will be set by Docker

# Disable dangerous commands in production
rename-command FLUSHDB "NEXTVISION_FLUSHDB_ADMIN_ONLY"
rename-command FLUSHALL "NEXTVISION_FLUSHALL_ADMIN_ONLY"
rename-command DEBUG ""
rename-command CONFIG "NEXTVISION_CONFIG_ADMIN_ONLY"
rename-command SHUTDOWN "NEXTVISION_SHUTDOWN_ADMIN_ONLY"

# ==========================================
# üíæ MEMORY CONFIGURATION
# ==========================================

# Maximum memory (will be limited by Docker)
maxmemory 512mb
maxmemory-policy allkeys-lru

# Memory optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# ==========================================
# üíΩ PERSISTENCE CONFIGURATION
# ==========================================

# RDB snapshots
save 900 1     # Save if at least 1 key changed in 900 seconds
save 300 10    # Save if at least 10 keys changed in 300 seconds
save 60 10000  # Save if at least 10000 keys changed in 60 seconds

# RDB configuration
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename nextvision-cache.rdb
dir /data

# AOF configuration (disabled for performance, RDB sufficient for cache)
appendonly no
# appendfilename "nextvision-cache.aof"
# appendfsync everysec
# no-appendfsync-on-rewrite no
# auto-aof-rewrite-percentage 100
# auto-aof-rewrite-min-size 64mb

# ==========================================
# ‚ö° PERFORMANCE TUNING
# ==========================================

# Client configuration
timeout 300
tcp-keepalive 300

# Performance tuning
lazy-free-lazy-eviction yes
lazy-free-lazy-expire yes
lazy-free-lazy-server-del yes

# Background task tuning
hz 10

# ==========================================
# üìä LOGGING CONFIGURATION
# ==========================================

# Log level: debug, verbose, notice, warning
loglevel notice
logfile ""

# Syslog configuration
# syslog-enabled yes
# syslog-ident nextvision-redis
# syslog-facility local0

# ==========================================
# üîß SLOW LOG CONFIGURATION
# ==========================================

# Slow log configuration
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128

# ==========================================
# üöÄ CLIENT & CONNECTION LIMITS
# ==========================================

# Connection limits
maxclients 10000

# Client buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ==========================================
# üîç MONITORING & STATS
# ==========================================

# Enable latency monitoring
latency-monitor-threshold 100

# ==========================================
# üõ†Ô∏è ADVANCED CONFIGURATION
# ==========================================

# Disable Lua debugging (production)
lua-debugging no

# Always show logos
always-show-logo yes

# Notification configuration
notify-keyspace-events "Ex"

# ==========================================
# üéØ NEXTVISION SPECIFIC
# ==========================================

# Optimized for Nextvision cache patterns:
# - Geocoding results (large values, long TTL)
# - Transport calculations (medium values, medium TTL)  
# - Matching results (small values, short TTL)

# Hash configuration for structured data
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# String optimization for cache keys
hash-max-ziplist-entries 1024

# ==========================================
# üìù CONFIGURATION NOTES
# ==========================================

# Production optimizations applied:
# ‚úÖ Memory management with LRU eviction
# ‚úÖ Persistence with RDB snapshots
# ‚úÖ Security with renamed dangerous commands
# ‚úÖ Performance tuning for cache workload
# ‚úÖ Slow query monitoring
# ‚úÖ Connection limits configured
# ‚úÖ Logging optimized for production
# ‚úÖ Keyspace notifications for cache invalidation

# For Nextvision cache usage:
# - Geocoding: SET key value EX 86400 (24h)
# - Transport: SET key value EX 21600 (6h)
# - Matching: SET key value EX 3600 (1h)
# - Health: SET key value EX 300 (5min)

# Memory usage estimation:
# - 10k geocoding entries: ~50MB
# - 100k transport calculations: ~200MB
# - 1M matching results: ~100MB
# Total estimated: ~350MB (well within 512MB limit)
